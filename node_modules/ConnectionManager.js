var Utils = require("./Utils"),
    request = require("request");

class ConnectionManager {
    constructor(app) {
        this.app = app;
        this.utils = new Utils();
        app.get("/countries/", this.getCountryList.bind(this));
        app.get("/competitions/", this.getAllCompetitions.bind(this));
        app.get("/competition/:idcompetition/results", this.getCompetitionResults.bind(this));
        app.get("/competition/:idcompetition/rankings", this.getCompetitionRankings.bind(this));
        app.get("/teams/:teamid/roster", this.getTeamRoster.bind(this));
        app.get("/teams/:teamid", this.getTeamInfo.bind(this));
        app.get("/player/:playerid", this.getPlayerInfo.bind(this)); // Récupérer l'effectif puis prendre les infos de l'id du joueur
        
    }
    
    getCountryList(req, res) {
        
        let countries = this.utils.getCountryList();
        
        res.send(countries);
    }
    
    getAllCompetitions(req, res) {
        
        res.send();
        
    }
    getCompetitionResults(req, res) {
        let url = this.utils.generateRequest({request_type: "results", competition_id: req.params.idcompetition});
        
    
        return this.getData(url).then((data) => {
            //console.log(data);
           res.send(data); 
        });
        
    }
    
    getCompetitionRankings(req, res) {
        let url = this.utils.generateRequest({});
        console.log("Appel classement");
        return this.getData(url).then((data) => {
            console.log(data);
           res.send(data); 
        }).catch((err) => {
            console.log("Erreur classement compétition");
        });
    }
    
    
    getTeamRoster(req, res) {
        console.log("appel roster");
        res.end();
        
    }
    
    getTeamInfo(req, res) {
        console.log("appel teaminfo");
        res.end();
        
    }
    
    getPlayerInfo(req, res) {
        console.log("appel playerinfo");
        res.end();
        
    }
    
    getData(url) {
        return new Promise((resolve, reject) => {
            request.get({
                url:url,
                json:true,
                headers: { "X-Auth-Token": process.env.FOOTBALLAPIKEY }
            }, (err, response, data) => {
                console.log(response.statusCode);
                if(response.statusCode !== 200) {
                    console.log(response.statusCode);
                    console.log(data);
                    reject(data);
                } else {
                    resolve(data);    
                }
 
                
            });
        }).catch((err) => {
            console.log("cATCH : ");
            console.log(err);
            console.log("Erreur");
        });
    }
}

module.exports = ConnectionManager;